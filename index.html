<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=no">
  <title>Floor View - Network Monitoring System</title>
  <style>
    /* ================= GLOBAL & RESET ================= */
    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0; 
      -webkit-tap-highlight-color: transparent; 
    }
    
    body {
      font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #f5f1e8;
      color: #1f2937;
      height: 100vh;
      width: 100vw;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    /* ================= HEADER ================= */
    .header {
      background: #fefce8;
      height: 70px;
      padding: 0 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-bottom: 3px solid #fde047;
      z-index: 100;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      flex-shrink: 0;
      transition: all 0.3s ease;
      position: relative;
    }
    
    .header.data-mode {
      border-bottom: 4px solid #06b6d4;
    }
    
    .header.media-mode {
      border-bottom: 4px solid #f59e0b;
    }
    
    .header-left {
      position: absolute;
      left: 30px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .app-icon {
      width: 42px;
      height: 42px;
      background: #475569;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: #ec4899;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    
    .app-title {
      display: flex;
      flex-direction: column;
    }
    
    .app-title h1 {
      color: #2d3748;
      font-size: 18px;
      font-weight: 700;
      margin: 0;
    }
    
    .app-subtitle {
      color: #9ca3af;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 600;
    }
    
    .count-badge {
      background: #f59e0b;
      color: white;
      font-size: 13px;
      font-weight: 600;
      padding: 4px 12px;
      border-radius: 16px;
      margin-left: 12px;
      box-shadow: 0 2px 6px rgba(245, 158, 11, 0.3);
    }

    /* ================= MODE TOGGLE ================= */
    .mode-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }
    
    .mode-label {
      color: #6b7280;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.8px;
    }
    
    .mode-toggle {
      display: flex;
      gap: 0;
      background: #f3f4f6;
      padding: 4px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
    }
    
    .mode-btn {
      background: transparent;
      color: #6b7280;
      border: none;
      padding: 8px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 130px;
      justify-content: center;
    }
    
    .mode-btn:hover {
      background: rgba(249, 250, 251, 0.8);
      color: #374151;
    }
    
    .mode-btn.active {
      background: #06b6d4;
      color: #ffffff;
      box-shadow: 0 2px 6px rgba(6, 182, 212, 0.3);
      border: 1px solid #0891b2;
    }

    /* ================= HEADER CONTROLS (Right) ================= */
    .header-right {
      position: absolute;
      right: 30px;
      display: flex;
      gap: 8px;
    }
    
    .btn {
      background: #ffffff;
      color: #4b5563;
      border: 1px solid #e5e7eb;
      width: 38px;
      height: 38px;
      border-radius: 8px;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      font-weight: 600;
    }
    
    .btn:hover { 
      background: #cffafe;
      border-color: #06b6d4;
      color: #0891b2;
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(6, 182, 212, 0.3);
    }
    
    .btn.reset-btn { 
      width: auto; 
      padding: 0 16px; 
      font-size: 13px;
    }

    /* ================= VIEWPORT & MAP ================= */
    #viewport {
      flex: 1;
      position: relative;
      overflow: hidden;
      background: #faf8f3;
      touch-action: none;
      cursor: grab;
      box-shadow: inset 0 0 20px rgba(0,0,0,0.03);
    }
    
    #viewport.grabbing { cursor: grabbing; }

    #map-container {
      position: absolute;
      top: 0; left: 0;
      transform-origin: 0 0;
      will-change: transform;
    }
    
    #floorImage {
      display: block;
      pointer-events: none;
      user-select: none;
      -webkit-user-drag: none;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
    }

    /* ================= POINTS ================= */
    .point {
      position: absolute;
      background: #ffffff;
      border: 3px solid #06b6d4;
      color: #111827;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-family: 'Segoe UI', Arial, sans-serif;
      cursor: pointer;
      z-index: 10;
      transition: all 0.2s;
      box-shadow: 0 3px 10px rgba(6, 182, 212, 0.4);
    }

    .point.media-point {
      background: #ffffff;
      border-color: #f59e0b;
      box-shadow: 0 3px 10px rgba(245, 158, 11, 0.3);
    }

    .point:hover {
      transform: translate(-50%, -50%) scale(1.15);
      z-index: 100;
    }

    .point.active {
      background: #ffffff;
      border-color: #0891b2;
      z-index: 20;
      box-shadow: 0 0 0 4px rgba(6, 182, 212, 0.3), 0 6px 16px rgba(6, 182, 212, 0.3);
      transform: translate(-50%, -50%) scale(1.3) !important;
    }

    /* ================= WELCOME DIALOG ================= */
    .welcome-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(8px);
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 1;
      transition: opacity 0.3s ease;
    }
    
    .welcome-overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }
    
    .welcome-dialog {
      background: white;
      border-radius: 20px;
      box-shadow: 0 25px 70px rgba(0,0,0,0.4);
      max-width: 520px;
      width: 90%;
      padding: 0;
      animation: slideUp 0.4s ease;
    }
    
    @keyframes slideUp {
      from {
        transform: translateY(30px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    .welcome-header {
      background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
      padding: 28px 32px;
      border-radius: 20px 20px 0 0;
      text-align: center;
    }
    
    .welcome-icon {
      font-size: 48px;
      margin-bottom: 12px;
    }
    
    .welcome-header h2 {
      color: white;
      font-size: 22px;
      font-weight: 700;
      margin: 0;
    }
    
    .welcome-content {
      padding: 32px;
      color: #374151;
      line-height: 1.7;
    }
    
    .welcome-content p {
      margin: 0 0 16px 0;
      font-size: 15px;
      font-weight: 600;
      color: #1f2937;
    }
    
    .welcome-content ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .welcome-content li {
      padding: 10px 0;
      font-size: 14px;
      border-bottom: 1px solid #f3f4f6;
    }
    
    .welcome-content li:last-child {
      border-bottom: none;
    }
    
    .point-demo {
      color: #06b6d4;
      font-size: 18px;
      font-weight: bold;
    }
    
    .welcome-btn {
      width: calc(100% - 64px);
      margin: 0 32px 32px 32px;
      padding: 14px;
      background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 12px rgba(6, 182, 212, 0.3);
    }
    
    .welcome-btn:hover {
      background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(6, 182, 212, 0.4);
    }
    
    .help-icon-btn {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
      color: white;
      border: none;
      border-radius: 50%;
      font-size: 24px;
      cursor: pointer;
      box-shadow: 0 4px 16px rgba(6, 182, 212, 0.4);
      transition: all 0.3s;
      z-index: 500;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .help-icon-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(6, 182, 212, 0.5);
    }

    /* ================= BOTTOM SHEET ================= */
    .bottom-sheet {
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%) scale(0.95);
      width: 90%;
      max-width: 320px; /* Default narrow width for data */
      max-height: 85vh;
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      opacity: 0;
      pointer-events: none;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      z-index: 1000;
    }

    .bottom-sheet.open {
      opacity: 1;
      pointer-events: auto;
      transform: translate(-50%, -50%) scale(1);
    }

    /* Wide Mode for Media to prevent scrolling */
    .bottom-sheet.media-viewer {
      max-width: 900px;
      width: 95vw;
      background: #fff; /* White background for images */
      border: 1px solid #e5e7eb;
    }
    
    /* When in media mode, header is clean and simple */
    .bottom-sheet.media-viewer .sheet-header {
      background: #f9fafb;
      border-bottom: 1px solid #e5e7eb;
    }
    .bottom-sheet.media-viewer .sheet-name { color: #1f2937; }
    .bottom-sheet.media-viewer .sheet-id { color: #f59e0b; }
    .bottom-sheet.media-viewer .close-btn { 
      background: rgba(0,0,0,0.05); 
      color: #4b5563; 
    }
    .bottom-sheet.media-viewer .close-btn:hover { background: rgba(0,0,0,0.1); }
    
    /* Dark theme only when video is present */
    .bottom-sheet.media-viewer:has(.video-mode) {
      background: #000;
      border: 1px solid #333;
    }
    
    .bottom-sheet.media-viewer:has(.video-mode) .sheet-header {
      background: #1a1a1a;
      border-bottom: 1px solid #333;
    }
    
    .bottom-sheet.media-viewer:has(.video-mode) .sheet-name { color: #fff; }
    .bottom-sheet.media-viewer:has(.video-mode) .close-btn { 
      background: rgba(255,255,255,0.2); 
      color: white; 
    }
    .bottom-sheet.media-viewer:has(.video-mode) .close-btn:hover { background: rgba(255,255,255,0.4); }


    .sheet-header {
      padding: 12px 16px;
      border-bottom: 2px solid #f3f4f6;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      flex-shrink: 0;
    }

    .sheet-title {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .sheet-id {
      font-size: 18px;
      font-weight: 800;
      color: #d97706;
      font-family: monospace;
    }

    .sheet-name {
      font-size: 13px;
      font-weight: 700;
      color: #78350f;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .close-btn {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.5);
      border: none;
      font-size: 18px;
      color: #78350f;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .close-btn:hover {
      background: #ffffff;
      transform: scale(1.1);
    }

    /* CONTENT AREA */
    .sheet-content {
      padding: 12px;
      overflow-y: auto;
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
      align-content: start;
    }
    
    /* Remove grid and padding for media view to fit perfectly */
    .bottom-sheet.media-viewer .sheet-content {
      display: flex;
      flex-direction: column;
      padding: 0;
      overflow: hidden; /* Prevent scroll */
      background: #fff; /* White for images */
      height: 100%;
      justify-content: center;
    }
    
    /* Black background only when video is present */
    .bottom-sheet.media-viewer:has(.video-mode) .sheet-content {
      background: #000;
    }

    /* ================= COMPACT & CENTERED SIGNAL BOXES ================= */
    .signal-box {
      background: #ffffff;
      padding: 8px 4px; /* Reduced padding */
      border-radius: 8px;
      border: 2px solid #cbd5e1;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      transition: all 0.2s;
      
      /* Centering Magic */
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    .signal-box:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      border-color: #06b6d4;
    }

    .signal-box.main-signal {
      grid-column: 1 / -1;
      background: #f0f9ff;
      border-color: #06b6d4;
      border-width: 3px;
      padding: 10px;
      box-shadow: 0 3px 8px rgba(6, 182, 212, 0.2);
    }

    .signal-name {
      font-size: 9px;
      font-weight: 700;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 2px;
    }

    .signal-value {
      font-size: 18px; /* Larger for better visibility */
      font-weight: 900;
      font-family: monospace;
      line-height: 1.1;
    }

    .signal-box:not(.main-signal) .signal-value {
      font-size: 16px;
    }

    .val-green { color: #059669; }
    .val-yellow { color: #d97706; }
    .val-red { color: #dc2626; }

    /* ================= IMPROVED MEDIA DISPLAY ================= */
    .media-display {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #ffffff; /* White background for images */
      position: relative;
      padding: 12px;
    }
    
    /* Black background only for video */
    .media-display.video-mode {
      background: #000;
    }

    /* Key change: object-fit: contain ensures full image is visible */
    .media-display img,
    .media-display video {
      max-width: 100%;
      max-height: calc(85vh - 120px); /* Account for header and padding */
      width: auto;
      height: auto;
      object-fit: contain; /* Ensures the whole image/video is visible */
      display: block;
      border-radius: 8px;
    }

    .media-caption {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.7);
      padding: 8px 12px;
      color: #e2e8f0;
      font-size: 12px;
      text-align: center;
      backdrop-filter: blur(4px);
    }

    /* ================= LOADING ================= */
    .loading {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 30px 50px;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.15);
      text-align: center;
      z-index: 500;
    }

    .loading.hidden {
      display: none;
    }

    /* ================= RESPONSIVE ================= */
    @media (max-width: 768px) {
      .header {
        height: auto;
        flex-direction: column;
        padding: 12px 16px;
        gap: 12px;
      }

      .header-left,
      .header-right {
        position: static;
      }

      .mode-container {
        order: 1;
      }

      .header-left {
        order: 2;
      }

      .header-right {
        order: 3;
      }

      .app-title h1 {
        font-size: 16px;
      }

      .mode-btn {
        min-width: 100px;
        padding: 8px 16px;
        font-size: 13px;
      }

      .sheet-content {
        grid-template-columns: 1fr;
        gap: 6px;
      }

      .signal-box.main-signal {
        grid-column: 1;
      }
      
      .bottom-sheet.media-viewer {
         max-height: 80vh;
      }
      
      .media-display img,
      .media-display video {
        max-height: 70vh;
      }
    }
  </style>
</head>
<body>
  <!-- ================= WELCOME DIALOG ================= -->
  <div id="welcomeOverlay" class="welcome-overlay">
    <div class="welcome-dialog">
      <div class="welcome-header">
        <div class="welcome-icon">üì°</div>
        <h2>Welcome to Network Monitoring System</h2>
      </div>
      <div class="welcome-content">
        <p><strong>üìã How to use this viewer:</strong></p>
        <ul>
          <li>üëÜ Click on any <span class="point-demo">‚óè</span> point to see the received signal strength data at that location</li>
          <li>üìä Data shows the average of 10 samples per measurement point</li>
          <li>üé¨ Switch to Media mode to view images and videos at specific locations</li>
          <li>üîç Use zoom controls (+/-) and drag to navigate the floor plan</li>
        </ul>
      </div>
      <button class="welcome-btn" onclick="closeWelcome()">Get Started</button>
    </div>
  </div>

  <!-- ================= HELP BUTTON ================= -->
  <button class="help-icon-btn" id="helpBtn" title="Show instructions">?</button>

  <div class="header data-mode" id="header">
    <div class="header-left">
      <div class="app-icon">üì°</div>
      <div class="app-title">
        <h1>Network Monitoring System</h1>
        <div class="app-subtitle">Floor View</div>
      </div>
      <div class="count-badge" id="pointCount">0</div>
    </div>

    <div class="mode-container">
      <div class="mode-label">View Mode</div>
      <div class="mode-toggle">
        <button class="mode-btn active" id="btnDataMode">
          üìä Data Points
        </button>
        <button class="mode-btn" id="btnMediaMode">
          üì∑üé• Media
        </button>
      </div>
    </div>

    <div class="header-right">
      <button class="btn" id="btnPlus" title="Zoom In">+</button>
      <button class="btn" id="btnMinus" title="Zoom Out">‚àí</button>
      <button class="btn" id="btnFit" title="Fit to Screen">‚ä°</button>
      <button class="btn reset-btn" id="btnReset" title="Reset View">‚Üª Reset</button>
    </div>
  </div>

  <div id="viewport">
    <div id="map-container">
      <img id="floorImage" src="floor1.jpg" alt="Floor Plan">
    </div>
  </div>

  <div class="bottom-sheet" id="bottomSheet">
    <div class="sheet-header">
      <div class="sheet-title">
        <div class="sheet-id" id="sheetId">#1</div>
        <div class="sheet-name" id="sheetName">Measurement Point</div>
      </div>
      <button class="close-btn" id="closeSheet">√ó</button>
    </div>
    <div class="sheet-content" id="sheetContent"></div>
  </div>

  <div class="loading" id="loadingStatus">
    <div style="font-size: 32px; margin-bottom: 12px;">‚è≥</div>
    <div style="font-weight: 600; color: #374151;">Loading floor data...</div>
  </div>

<script>
  const CONFIG = {
    minScale: 0.1,
    maxScale: 10,
    zoomStep: 1.2
  };

  const state = {
    points: [],
    mediaPoints: [],
    scale: 1,
    x: 0,
    y: 0,
    isDragging: false,
    startX: 0,
    startY: 0,
    initialViewport: null,
    defaultPointSize: 28
  };

  let currentMode = 'data';

  const els = {
    viewport: document.getElementById('viewport'),
    container: document.getElementById('map-container'),
    img: document.getElementById('floorImage'),
    sheet: document.getElementById('bottomSheet'),
    status: document.getElementById('loadingStatus'),
    count: document.getElementById('pointCount'),
    header: document.getElementById('header')
  };

  document.getElementById('btnDataMode').onclick = () => {
    currentMode = 'data';
    document.getElementById('btnDataMode').classList.add('active');
    document.getElementById('btnMediaMode').classList.remove('active');
    els.header.className = 'header data-mode';
    renderPoints();
  };

  document.getElementById('btnMediaMode').onclick = () => {
    currentMode = 'media';
    document.getElementById('btnDataMode').classList.remove('active');
    document.getElementById('btnMediaMode').classList.add('active');
    els.header.className = 'header media-mode';
    renderPoints();
  };

  async function init() {
    setupEventListeners();
    await loadData();
    els.img.onload = () => {
      if (state.initialViewport) {
        applyInitialViewport();
      } else {
        fitMapToScreen();
      }
    };
  }

  async function loadData() {
    try {
      const res = await fetch('floor_full_data.json');
      const data = await res.json();
      
      if (data.points) {
        state.points = data.points.filter(p => p.type === 'data');
        state.mediaPoints = data.points.filter(p => p.type === 'media');
        
        if (data.viewportConfig) {
          state.initialViewport = data.viewportConfig;
          state.defaultPointSize = data.viewportConfig.pointSize || 28;
          applyInitialViewport();
        } else {
          fitMapToScreen();
        }
      }
      updateCount();
      els.status.classList.add('hidden');
      renderPoints();
    } catch (err) {
      console.error(err);
      els.status.innerHTML = `‚ö†Ô∏è <b>No Data</b><br><small>Check console</small>`;
      els.status.classList.remove('hidden');
      fitMapToScreen();
    }
  }

  function updateCount() {
    els.count.textContent = currentMode === 'data' ? state.points.length : state.mediaPoints.length;
  }

  function applyInitialViewport() {
    if (!state.initialViewport) { fitMapToScreen(); return; }
    state.scale = state.initialViewport.scale || 1;
    state.x = state.initialViewport.x || 0;
    state.y = state.initialViewport.y || 0;
    updateTransform();
  }

  function renderPoints() {
    document.querySelectorAll('.point').forEach(p => p.remove());
    const pointsToShow = currentMode === 'data' ? state.points : state.mediaPoints;

    pointsToShow.forEach(p => {
      const el = document.createElement('div');
      el.className = 'point';
      
      if (p.type === 'media') {
        el.classList.add('media-point');
        if (p.mediaType && p.mediaType.startsWith('video/')) {
          el.textContent = 'üé•';
        } else {
          el.textContent = 'üì∑';
        }
      } else {
        el.textContent = p.row;
      }
      
      el.style.left = p.x + 'px';
      el.style.top = p.y + 'px';
      el.dataset.baseSize = p.size || state.defaultPointSize;
      
      el.addEventListener('click', (e) => {
        e.stopPropagation();
        openSheet(p, el);
      });
      els.container.appendChild(el);
    });
    
    updatePointScale();
    updateCount();
  }

  function updateTransform() {
    els.container.style.transform = `translate(${state.x}px, ${state.y}px) scale(${state.scale})`;
    updatePointScale();
  }

  function updatePointScale() {
    const inverseScale = 1 / state.scale;
    document.querySelectorAll('.point').forEach(el => {
      const baseSize = parseInt(el.dataset.baseSize);
      let size = baseSize * inverseScale;
      if (size < 20) size = 20; 
      
      el.style.width = size + 'px';
      el.style.height = size + 'px';
      el.style.fontSize = (size * 0.5) + 'px';
      el.style.borderWidth = Math.max(2, size * 0.1) + 'px';
    });
  }

  function fitMapToScreen() {
    const vw = els.viewport.clientWidth;
    const vh = els.viewport.clientHeight;
    const iw = els.img.naturalWidth || 2000;
    const ih = els.img.naturalHeight || 2000;
    const scaleW = vw / iw;
    const scaleH = vh / ih;
    state.scale = Math.min(scaleW, scaleH) * 0.95;
    state.x = (vw - iw * state.scale) / 2;
    state.y = (vh - ih * state.scale) / 2;
    updateTransform();
  }

  function setupEventListeners() {
    els.viewport.addEventListener('mousedown', e => {
      if(e.target.closest('.point')) return;
      state.isDragging = true;
      state.startX = e.clientX - state.x;
      state.startY = e.clientY - state.y;
      els.viewport.classList.add('grabbing');
    });

    window.addEventListener('mousemove', e => {
      if (!state.isDragging) return;
      e.preventDefault();
      state.x = e.clientX - state.startX;
      state.y = e.clientY - state.startY;
      updateTransform();
    });

    window.addEventListener('mouseup', () => {
      state.isDragging = false;
      els.viewport.classList.remove('grabbing');
    });

    els.viewport.addEventListener('wheel', e => {
      e.preventDefault();
      const factor = e.deltaY > 0 ? 0.9 : 1.1;
      const rect = els.viewport.getBoundingClientRect();
      const mx = e.clientX - rect.left;
      const my = e.clientY - rect.top;
      zoomToPoint(mx, my, factor);
    }, { passive: false });

    let lastTouchDist = 0;
    els.viewport.addEventListener('touchstart', e => {
      if (e.touches.length === 1) {
        state.isDragging = true;
        state.startX = e.touches[0].clientX - state.x;
        state.startY = e.touches[0].clientY - state.y;
      } else if (e.touches.length === 2) {
        state.isDragging = false;
        lastTouchDist = getDist(e.touches);
      }
    }, {passive: false});

    els.viewport.addEventListener('touchmove', e => {
      e.preventDefault();
      if (e.touches.length === 1 && state.isDragging) {
        state.x = e.touches[0].clientX - state.startX;
        state.y = e.touches[0].clientY - state.startY;
        updateTransform();
      } else if (e.touches.length === 2) {
        const dist = getDist(e.touches);
        const center = getCenter(e.touches);
        const factor = dist / lastTouchDist;
        const rect = els.viewport.getBoundingClientRect();
        zoomToPoint(center.x - rect.left, center.y - rect.top, factor);
        lastTouchDist = dist;
      }
    }, {passive: false});

    els.viewport.addEventListener('touchend', () => state.isDragging = false);

    document.getElementById('btnPlus').onclick = () => zoomAtCenter(CONFIG.zoomStep);
    document.getElementById('btnMinus').onclick = () => zoomAtCenter(1 / CONFIG.zoomStep);
    document.getElementById('btnFit').onclick = fitMapToScreen;
    document.getElementById('btnReset').onclick = () => state.initialViewport ? applyInitialViewport() : fitMapToScreen();
    document.getElementById('closeSheet').onclick = closeSheet;
    els.viewport.addEventListener('click', closeSheet);
  }

  const getDist = (touches) => Math.hypot(touches[0].clientX - touches[1].clientX, touches[0].clientY - touches[1].clientY);
  const getCenter = (touches) => ({ x: (touches[0].clientX + touches[1].clientX) / 2, y: (touches[0].clientY + touches[1].clientY) / 2 });

  function zoomToPoint(mx, my, factor) {
    const oldScale = state.scale;
    let newScale = state.scale * factor;
    newScale = Math.max(CONFIG.minScale, Math.min(CONFIG.maxScale, newScale));
    state.x = mx - (mx - state.x) * (newScale / oldScale);
    state.y = my - (my - state.y) * (newScale / oldScale);
    state.scale = newScale;
    updateTransform();
  }

  function zoomAtCenter(factor) {
    const rect = els.viewport.getBoundingClientRect();
    zoomToPoint(rect.width/2, rect.height/2, factor);
  }

  function openSheet(data, element) {
    document.querySelectorAll('.point.active').forEach(p => p.classList.remove('active'));
    element.classList.add('active');

    const container = document.getElementById('sheetContent');
    container.innerHTML = '';

    if (data.type === 'media') {
      els.sheet.classList.add('media-viewer');
      
      if (data.mediaType && data.mediaType.startsWith('video/')) {
        document.getElementById('sheetId').textContent = 'üé•';
      } else {
        document.getElementById('sheetId').textContent = 'üì∑';
      }
      
      document.getElementById('sheetName').textContent = data.label || 'Media Point';
      
      if (data.mediaData) {
        const mediaContainer = document.createElement('div');
        mediaContainer.className = 'media-display';
        
        let mediaEl;
        if (data.mediaType && data.mediaType.startsWith('video/')) {
          mediaContainer.classList.add('video-mode'); // Add black background for video
          mediaEl = document.createElement('video');
          mediaEl.controls = true;
          mediaEl.src = data.mediaData;
        } else {
          mediaEl = document.createElement('img');
          mediaEl.src = data.mediaData;
        }
        
        mediaEl.alt = data.label || 'Media Content';
        mediaContainer.appendChild(mediaEl);
        
        if (data.caption) {
          const caption = document.createElement('div');
          caption.className = 'media-caption';
          caption.textContent = data.caption;
          mediaContainer.appendChild(caption);
        }
        
        container.appendChild(mediaContainer);
      } else {
        container.innerHTML = `<div style="text-align:center;color:#aaa;padding:20px;">No media data available</div>`;
      }
    } else {
      els.sheet.classList.remove('media-viewer');
      document.getElementById('sheetId').textContent = '#' + data.row;
      document.getElementById('sheetName').textContent = data.plate || 'Measurement Point';

      if (data.signals && Object.keys(data.signals).length > 0) {
        const entries = Object.entries(data.signals);
        entries.forEach(([key, val], index) => {
          const colorClass = getSignalColor(val);
          const isMain = index === 0;
          
          const box = document.createElement('div');
          box.className = `signal-box ${isMain ? 'main-signal' : ''}`;
          box.innerHTML = `<div class="signal-name">${key}</div><div class="signal-value ${colorClass}">${val}</div>`;
          container.appendChild(box);
        });
      } else {
        container.innerHTML = `<div style="grid-column:1/-1;text-align:center;color:#aaa;padding:10px;font-size:12px;">No signal data available</div>`;
      }
    }

    els.sheet.classList.add('open');
  }

  function getSignalColor(value) {
    if (value > -45) return 'val-green';
    if (value >= -80) return 'val-yellow';
    return 'val-red';
  }

  function closeSheet() {
    els.sheet.classList.remove('open');
    // Stop video if playing
    const video = document.querySelector('.media-display video');
    if (video) video.pause();
    document.querySelectorAll('.point.active').forEach(p => p.classList.remove('active'));
  }

  // ================= WELCOME DIALOG FUNCTIONS =================
  function closeWelcome() {
    const overlay = document.getElementById('welcomeOverlay');
    overlay.classList.add('hidden');
    // Mark as shown in localStorage
    localStorage.setItem('welcomeShown', 'true');
  }

  function showWelcome() {
    const overlay = document.getElementById('welcomeOverlay');
    overlay.classList.remove('hidden');
  }

  function checkFirstVisit() {
    const hasSeenWelcome = localStorage.getItem('welcomeShown');
    if (!hasSeenWelcome) {
      // Show welcome on first visit
      showWelcome();
    } else {
      // Hide welcome if already seen
      document.getElementById('welcomeOverlay').classList.add('hidden');
    }
  }

  // Help button click handler
  document.getElementById('helpBtn').onclick = showWelcome;

  // Check if first visit when page loads
  window.addEventListener('load', checkFirstVisit);

  init();
</script>
</body>
</html>