<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Floor Plan Editor - Network Monitoring System</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #f5f7fa;
      height: 100vh; 
      display: flex; 
      flex-direction: column; 
      overflow: hidden; 
    }
    
    .toolbar {
      background: #fefce8;
      padding: 16px 20px;
      display: flex;
      gap: 12px;
      border-bottom: 1px solid #fde047;
      flex-wrap: wrap;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .toolbar-group {
      display: flex;
      gap: 10px;
      align-items: center;
      padding: 0 16px;
      border-right: 1px solid #e2e8f0;
    }
    .toolbar-group:last-child { border-right: none; }
    
    .toolbar-label { 
      color: #64748b; 
      font-size: 11px; 
      text-transform: uppercase; 
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    
    .btn {
      padding: 10px 16px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      background: white;
      color: #475569;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    .btn:hover { 
      background: #f8fafc;
      border-color: #3b82f6;
      color: #3b82f6;
      box-shadow: 0 2px 6px rgba(59, 130, 246, 0.2);
    }
    .btn.active { 
      background: #3b82f6;
      color: white;
      border-color: #3b82f6;
    }
    .btn.save { 
      background: #10b981;
      color: white;
      border-color: #10b981;
      padding: 10px 20px;
    }
    .btn.save:hover {
      background: #059669;
    }
    .btn.viewport-btn { background: #6366f1; color: white; border-color: #6366f1; }
    .btn.viewport-btn:hover { background: #4f46e5; }
    .btn.viewport-btn.saved { 
      background: #10b981;
      border-color: #10b981;
    }
    .btn.media-mode { 
      background: #06b6d4; 
      color: white; 
      border-color: #06b6d4; 
    }
    .btn.media-mode.active { 
      background: #0891b2; 
    }
    .btn.media-mode:hover { 
      background: #0e7490; 
    }
    
    input[type=number], input[type=text] { 
      padding: 10px;
      width: 70px;
      background: white;
      border: 1px solid #e2e8f0;
      color: #1e293b;
      border-radius: 6px;
      font-size: 13px;
    }
    input[type=text].wide { width: 200px; }
    input[type=number]:focus, input[type=text]:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    input[type=range] {
      width: 150px;
      height: 6px;
      background: #e2e8f0;
      border-radius: 3px;
      outline: none;
      -webkit-appearance: none;
    }
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      background: #3b82f6;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    input[type=range]::-moz-range-thumb {
      width: 18px;
      height: 18px;
      background: #3b82f6;
      border-radius: 50%;
      cursor: pointer;
      border: none;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    input[type=file] { display: none; }
    
    #viewport { 
      flex: 1; 
      position: relative; 
      background: #f8fafc; 
      overflow: hidden; 
      cursor: crosshair;
      box-shadow: inset 0 0 20px rgba(0,0,0,0.03);
    }
    #map-container { position: absolute; transform-origin: 0 0; }
    
    .point {
      position: absolute;
      background: #ffffff;
      border: 3px solid #06b6d4;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      color: #000000;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 900;
      font-family: Arial, sans-serif;
      box-shadow: 0 2px 8px rgba(6, 182, 212, 0.4);
    }
    .point.media-point {
      background: #ffffff;
      border-color: #f59e0b;
      box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
    }
    .point:hover { 
      transform: translate(-50%, -50%) scale(1.2); 
      z-index: 100; 
      box-shadow: 0 4px 12px rgba(6, 182, 212, 0.6);
    }
    .point.media-point:hover {
      box-shadow: 0 4px 12px rgba(245, 158, 11, 0.5);
    }
    
    .sidebar { 
      width: 340px; 
      background: #dbeafe;
      border-left: 1px solid #bfdbfe;
      display: flex; 
      flex-direction: column;
      box-shadow: -2px 0 8px rgba(0,0,0,0.05);
    }
    
    .sidebar-section {
      padding: 20px;
      border-bottom: 1px solid #f1f5f9;
    }
    .sidebar-section h4 { 
      color: #1e293b; 
      margin-bottom: 12px; 
      font-size: 13px; 
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 700;
    }
    
    .viewport-info {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .info-item {
      background: #f8fafc;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }
    .info-item .label { 
      color: #64748b; 
      font-size: 10px; 
      text-transform: uppercase;
      margin-bottom: 4px;
      font-weight: 600;
    }
    .info-item .value { 
      color: #3b82f6; 
      font-size: 16px; 
      font-weight: 700; 
      font-family: monospace;
    }
    
    .point-list { flex: 1; overflow-y: auto; padding: 12px; background: #f8fafc; }
    .log-item { 
      padding: 12px;
      border-bottom: 1px solid #e2e8f0;
      color: #1e293b;
      font-size: 13px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-radius: 6px;
      margin-bottom: 6px;
      background: white;
      transition: all 0.2s;
      border-left: 3px solid #06b6d4;
    }
    .log-item:hover { 
      background: #ecfeff;
      transform: translateX(3px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .log-item.media-item { border-left-color: #f59e0b; }
    .log-item.media-item:hover { background: #fffbeb; }
    .del-btn { 
      color: #ef4444; 
      cursor: pointer; 
      font-weight: 700; 
      padding: 4px 10px;
      border-radius: 4px;
      transition: all 0.2s;
    }
    .del-btn:hover {
      background: #ef4444;
      color: white;
    }
    
    .status-bar {
      background: white;
      padding: 12px 20px;
      border-top: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      color: #64748b;
      font-size: 11px;
      box-shadow: 0 -2px 8px rgba(0,0,0,0.05);
    }
    .status-indicator { display: flex; align-items: center; gap: 8px; }
    .status-dot { 
      width: 10px; 
      height: 10px; 
      border-radius: 50%;
      box-shadow: 0 0 6px currentColor;
    }
    .status-dot.saved { background: #10b981; color: #10b981; }
    .status-dot.unsaved { background: #f59e0b; color: #f59e0b; }
    
    #savedViewSection {
      display: none;
      background: #f8fafc;
      padding: 16px;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }
    
    #sizePreview {
      display: inline-block;
      background: #ffffff;
      border: 3px solid #06b6d4;
      border-radius: 50%;
      color: #000;
      font-weight: 900;
      text-align: center;
      line-height: 1;
      margin-left: 8px;
      vertical-align: middle;
      box-shadow: 0 2px 6px rgba(6, 182, 212, 0.3);
    }
    
    #viewportFrame {
      display: none;
      position: absolute;
      border: 3px dashed #3b82f6;
      pointer-events: none;
      z-index: 1000;
      background: rgba(59, 130, 246, 0.05);
    }
    
    #viewportFrame.active { display: block; }

    /* Media Preview Panel */
    .media-preview-panel {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      z-index: 2000;
      max-width: 600px;
      max-height: 85vh;
      overflow: hidden;
    }

    .media-preview-panel.active {
      display: flex;
      flex-direction: column;
    }

    .media-preview-header {
      background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
      padding: 20px;
      color: white;
    }

    .media-preview-header h3 {
      font-size: 18px;
      margin-bottom: 8px;
    }

    .media-preview-header p {
      font-size: 13px;
      opacity: 0.9;
    }

    .media-preview-content {
      padding: 20px;
      overflow-y: auto;
      max-height: calc(85vh - 200px);
    }

    .media-preview-content img,
    .media-preview-content video {
      width: 100%;
      border-radius: 12px;
      margin-bottom: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .media-preview-content video {
      background: #000;
    }

    .media-preview-form {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .media-preview-form label {
      font-size: 12px;
      font-weight: 600;
      color: #475569;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    .media-preview-form input,
    .media-preview-form textarea {
      padding: 10px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      width: 100%;
    }

    .media-preview-form textarea {
      resize: vertical;
      min-height: 60px;
      font-family: inherit;
    }

    .media-preview-actions {
      padding: 16px 20px;
      border-top: 1px solid #e2e8f0;
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      background: #f8fafc;
    }

    .media-preview-actions button {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .media-preview-actions .btn-cancel {
      background: #e2e8f0;
      color: #475569;
    }

    .media-preview-actions .btn-cancel:hover {
      background: #cbd5e1;
    }

    .media-preview-actions .btn-ready {
      background: #06b6d4;
      color: white;
    }

    .media-preview-actions .btn-ready:hover {
      background: #0891b2;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(6, 182, 212, 0.3);
    }

    .media-ready-indicator {
      display: none;
      background: #dcfce7;
      color: #166534;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      margin: 12px 20px;
      border: 2px solid #86efac;
      animation: pulse 2s infinite;
    }

    .media-ready-indicator.active {
      display: block;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
  </style>
</head>
<body>
  <div class="toolbar">
    <div class="toolbar-group">
      <label class="toolbar-label">Mode</label>
      <button class="btn" id="btnDataMode">üìç Data Points</button>
      <button class="btn media-mode" id="btnMediaMode">üì∑üé• Media</button>
      <button class="btn" id="btnRemoveMode">üóëÔ∏è Remove</button>
    </div>
    
    <div class="toolbar-group">
      <label class="toolbar-label">Next ID</label>
      <input type="number" id="nextId" value="1" min="1">
    </div>
    
    <div class="toolbar-group">
      <label class="toolbar-label">Point Size</label>
      <input type="range" id="pointSizeSlider" min="1" max="200" value="40" step="1">
      <input type="number" id="pointSizeInput" min="1" max="200" value="40">
      <span id="sizePreview">1</span>
    </div>
    
    <div class="toolbar-group" id="mediaControls" style="display: none;">
      <input type="file" id="mediaUpload" accept="image/*,video/*">
      <button class="btn media-mode" id="btnUploadMedia">üì§ Upload Media</button>
    </div>
    
    <div class="toolbar-group">
      <button class="btn viewport-btn" id="btnSaveViewport">üíæ Save Viewport</button>
    </div>
    
    <div class="toolbar-group">
      <button class="btn" id="btnPlus">+</button>
      <button class="btn" id="btnMinus">‚àí</button>
      <button class="btn" id="btnFit">‚ä°</button>
    </div>
    
    <div class="toolbar-group">
      <button class="btn save" id="btnSave">üíæ Export JSON</button>
    </div>
  </div>

  <div class="media-ready-indicator" id="mediaReadyIndicator">
    ‚úÖ Media ready! Click anywhere on the map to place the point
  </div>

  <div style="display: flex; flex: 1; overflow: hidden;">
    <div id="viewport">
      <div id="map-container">
        <img id="floorImage" src="floor1.jpg" alt="Floor Plan">
      </div>
      <div id="viewportFrame"></div>
    </div>

    <div class="sidebar">
      <div class="sidebar-section">
        <h4>Viewport Info</h4>
        <div class="viewport-info">
          <div class="info-item"><div class="label">Zoom</div><div class="value" id="infoZoom">100%</div></div>
          <div class="info-item"><div class="label">Points</div><div class="value" id="infoPoints">0</div></div>
          <div class="info-item"><div class="label">Pan X</div><div class="value" id="infoPanX">0</div></div>
          <div class="info-item"><div class="label">Pan Y</div><div class="value" id="infoPanY">0</div></div>
        </div>
      </div>
      
      <div class="sidebar-section" id="savedViewSection">
        <h4>Saved Viewport</h4>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px;">
          <div><strong>Zoom:</strong> <span id="savedZoom">-</span></div>
          <div><strong>Size:</strong> <span id="savedSize">-</span></div>
        </div>
      </div>
      
      <div class="sidebar-section" style="flex: 1; display: flex; flex-direction: column; padding: 0;">
        <h4 style="padding: 20px 20px 12px;">Points List</h4>
        <div class="point-list" id="pointList"></div>
      </div>
    </div>
  </div>

  <!-- Media Preview Panel -->
  <div class="media-preview-panel" id="mediaPreviewPanel">
    <div class="media-preview-header">
      <h3 id="previewTitle">üì∑ Image Preview</h3>
      <p>Review your media before placing it on the floor plan</p>
    </div>
    <div class="media-preview-content">
      <div id="mediaPreviewContainer"></div>
      <div class="media-preview-form">
        <div>
          <label>Label / Name</label>
          <input type="text" id="previewLabel" placeholder="Enter a label for this media">
        </div>
        <div>
          <label>Caption (Optional)</label>
          <textarea id="previewCaption" placeholder="Add a description or note"></textarea>
        </div>
      </div>
    </div>
    <div class="media-preview-actions">
      <button class="btn-cancel" id="btnCancelMedia">Cancel</button>
      <button class="btn-ready" id="btnReadyToPlace">‚úì Ready to Place</button>
    </div>
  </div>

  <div class="status-bar">
    <div class="status-indicator">
      <div class="status-dot saved" id="statusDot"></div>
      <span id="statusText">Ready</span>
    </div>
    <div>Floor Plan Editor v2.1 - Media Preview Enabled</div>
  </div>

<script>
  const viewport = document.getElementById('viewport');
  const container = document.getElementById('map-container');
  const img = document.getElementById('floorImage');
  const nextIdInput = document.getElementById('nextId');
  const pointSizeSlider = document.getElementById('pointSizeSlider');
  const pointSizeInput = document.getElementById('pointSizeInput');
  const sizePreview = document.getElementById('sizePreview');
  const previewFrame = document.getElementById('viewportFrame');
  const mediaPreviewPanel = document.getElementById('mediaPreviewPanel');
  const mediaPreviewContainer = document.getElementById('mediaPreviewContainer');
  const previewTitle = document.getElementById('previewTitle');
  const previewLabel = document.getElementById('previewLabel');
  const previewCaption = document.getElementById('previewCaption');
  const mediaReadyIndicator = document.getElementById('mediaReadyIndicator');
  
  let scale = 1, x = 0, y = 0;
  let isDragging = false, startX = 0, startY = 0;
  let points = [];
  let savedViewport = null;
  let mode = 'data';
  let pointType = 'data';
  let currentPointSize = 40;
  let hasUnsavedChanges = false;
  let pendingMediaData = null;
  let mediaReadyToPlace = false;

  function updateSizePreview() {
    const size = parseInt(pointSizeInput.value);
    sizePreview.style.width = size + 'px';
    sizePreview.style.height = size + 'px';
    sizePreview.style.fontSize = (size * 0.5) + 'px';
    sizePreview.style.lineHeight = size + 'px';
    sizePreview.textContent = nextIdInput.value;
  }

  pointSizeSlider.addEventListener('input', e => {
    currentPointSize = parseInt(e.target.value);
    pointSizeInput.value = currentPointSize;
    updateSizePreview();
    document.querySelectorAll('.point').forEach(el => {
      const displaySize = (parseInt(el.dataset.size) || currentPointSize) / scale;
      el.style.width = displaySize + 'px';
      el.style.height = displaySize + 'px';
    });
  });

  pointSizeInput.addEventListener('input', e => {
    currentPointSize = parseInt(e.target.value);
    pointSizeSlider.value = currentPointSize;
    updateSizePreview();
    document.querySelectorAll('.point').forEach(el => {
      const displaySize = (parseInt(el.dataset.size) || currentPointSize) / scale;
      el.style.width = displaySize + 'px';
      el.style.height = displaySize + 'px';
    });
  });

  nextIdInput.addEventListener('input', updateSizePreview);
  updateSizePreview();

  function updateInfoDisplay() {
    document.getElementById('infoZoom').textContent = Math.round(scale * 100) + '%';
    document.getElementById('infoPoints').textContent = points.length;
    document.getElementById('infoPanX').textContent = Math.round(x);
    document.getElementById('infoPanY').textContent = Math.round(y);
  }

  function updateTransform() {
    container.style.transform = `translate(${x}px, ${y}px) scale(${scale})`;
    document.querySelectorAll('.point').forEach(el => {
      const displaySize = (parseInt(el.dataset.size) || currentPointSize) / scale;
      el.style.width = displaySize + 'px';
      el.style.height = displaySize + 'px';
    });
    updateInfoDisplay();
  }

  viewport.addEventListener('mousedown', e => {
    if (e.target !== viewport && e.target !== container && e.target !== img) return;
    isDragging = true;
    startX = e.clientX - x;
    startY = e.clientY - y;
    viewport.style.cursor = 'grabbing';
  });

  window.addEventListener('mousemove', e => {
    if (isDragging) {
      e.preventDefault();
      x = e.clientX - startX;
      y = e.clientY - startY;
      updateTransform();
    }
  });

  window.addEventListener('mouseup', () => {
    isDragging = false;
    viewport.style.cursor = mode === 'add' ? 'crosshair' : 'grab';
  });

  viewport.addEventListener('wheel', e => {
    e.preventDefault();
    const factor = e.deltaY > 0 ? 0.9 : 1.1;
    const rect = viewport.getBoundingClientRect();
    const mx = e.clientX - rect.left;
    const my = e.clientY - rect.top;
    
    const oldScale = scale;
    let newScale = scale * factor;
    newScale = Math.max(0.1, Math.min(10, newScale));
    
    x = mx - (mx - x) * (newScale / oldScale);
    y = my - (my - y) * (newScale / oldScale);
    scale = newScale;
    
    updateTransform();
  });

  function zoom(factor) {
    const rect = viewport.getBoundingClientRect();
    const cx = rect.width / 2;
    const cy = rect.height / 2;
    
    const oldScale = scale;
    let newScale = scale * factor;
    newScale = Math.max(0.1, Math.min(10, newScale));
    
    x = cx - (cx - x) * (newScale / oldScale);
    y = cy - (cy - y) * (newScale / oldScale);
    scale = newScale;
    
    updateTransform();
  }

  function fitToScreen() {
    const vw = viewport.clientWidth;
    const vh = viewport.clientHeight;
    const iw = img.naturalWidth || 2000;
    const ih = img.naturalHeight || 2000;
    
    const scaleW = vw / iw;
    const scaleH = vh / ih;
    scale = Math.min(scaleW, scaleH) * 0.95;
    
    x = (vw - iw * scale) / 2;
    y = (vh - ih * scale) / 2;
    
    updateTransform();
  }

  document.getElementById('btnDataMode').onclick = () => {
    mode = 'add';
    pointType = 'data';
    mediaReadyToPlace = false;
    mediaReadyIndicator.classList.remove('active');
    document.getElementById('btnDataMode').classList.add('active');
    document.getElementById('btnMediaMode').classList.remove('active');
    document.getElementById('btnRemoveMode').classList.remove('active');
    document.getElementById('mediaControls').style.display = 'none';
    viewport.style.cursor = 'crosshair';
    
    document.querySelectorAll('.point').forEach(el => {
      if (el.dataset.type === 'media') {
        el.style.display = 'none';
      } else {
        el.style.display = 'flex';
      }
    });
    
    renderSidebar();
  };

  document.getElementById('btnMediaMode').onclick = () => {
    mode = 'add';
    pointType = 'media';
    document.getElementById('btnDataMode').classList.remove('active');
    document.getElementById('btnMediaMode').classList.add('active');
    document.getElementById('btnRemoveMode').classList.remove('active');
    document.getElementById('mediaControls').style.display = 'flex';
    viewport.style.cursor = 'crosshair';
    
    document.querySelectorAll('.point').forEach(el => {
      if (el.dataset.type === 'media') {
        el.style.display = 'flex';
      } else {
        el.style.display = 'none';
      }
    });
    
    renderSidebar();
  };

  document.getElementById('btnRemoveMode').onclick = () => {
    mode = 'remove';
    mediaReadyToPlace = false;
    mediaReadyIndicator.classList.remove('active');
    document.getElementById('btnDataMode').classList.remove('active');
    document.getElementById('btnMediaMode').classList.remove('active');
    document.getElementById('btnRemoveMode').classList.add('active');
    document.getElementById('mediaControls').style.display = 'none';
    viewport.style.cursor = 'pointer';
    
    document.querySelectorAll('.point').forEach(el => {
      el.style.display = 'flex';
    });
    
    renderSidebar();
  };

  document.getElementById('btnDataMode').click();

  document.getElementById('btnUploadMedia').onclick = () => {
    document.getElementById('mediaUpload').click();
  };

  document.getElementById('mediaUpload').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (evt) => {
      pendingMediaData = {
        data: evt.target.result,
        name: file.name,
        type: file.type
      };
      
      showMediaPreview(pendingMediaData);
    };
    reader.readAsDataURL(file);
  });

  function showMediaPreview(mediaData) {
    mediaPreviewContainer.innerHTML = '';
    
    if (mediaData.type.startsWith('video/')) {
      previewTitle.textContent = 'üé• Video Preview';
      const video = document.createElement('video');
      video.src = mediaData.data;
      video.controls = true;
      video.style.width = '100%';
      video.style.borderRadius = '12px';
      video.style.background = '#000';
      mediaPreviewContainer.appendChild(video);
    } else {
      previewTitle.textContent = 'üì∑ Image Preview';
      const img = document.createElement('img');
      img.src = mediaData.data;
      img.style.width = '100%';
      img.style.borderRadius = '12px';
      mediaPreviewContainer.appendChild(img);
    }
    
    previewLabel.value = mediaData.name.replace(/\.[^/.]+$/, '');
    previewCaption.value = '';
    
    mediaPreviewPanel.classList.add('active');
  }

  document.getElementById('btnCancelMedia').onclick = () => {
    mediaPreviewPanel.classList.remove('active');
    mediaReadyIndicator.classList.remove('active');
    pendingMediaData = null;
    mediaReadyToPlace = false;
    document.getElementById('mediaUpload').value = '';
    setStatus('Media upload cancelled', 'saved');
  };

  document.getElementById('btnReadyToPlace').onclick = () => {
    if (!pendingMediaData) return;
    
    mediaReadyToPlace = true;
    mediaPreviewPanel.classList.remove('active');
    mediaReadyIndicator.classList.add('active');
    setStatus('‚úÖ Media ready - Click on map to place', 'unsaved');
  };

  viewport.addEventListener('click', e => {
    if (mode !== 'add' || (e.target !== viewport && e.target !== img && e.target !== container)) return;
    
    const rect = container.getBoundingClientRect();
    const clickX = (e.clientX - rect.left) / scale;
    const clickY = (e.clientY - rect.top) / scale;
    
    if (pointType === 'data') {
      const row = parseInt(nextIdInput.value);
      const pData = {
        type: 'data',
        row: row,
        x: clickX,
        y: clickY,
        size: currentPointSize
      };
      addPoint(pData);
      nextIdInput.value = row + 1;
      updateSizePreview();
    } else if (pointType === 'media' && pendingMediaData && mediaReadyToPlace) {
      const label = previewLabel.value || pendingMediaData.name;
      const caption = previewCaption.value || '';
      
      const pData = {
        type: 'media',
        x: clickX,
        y: clickY,
        size: currentPointSize,
        mediaData: pendingMediaData.data,
        mediaName: pendingMediaData.name,
        mediaType: pendingMediaData.type,
        label: label,
        caption: caption
      };
      addPoint(pData);
      
      pendingMediaData = null;
      mediaReadyToPlace = false;
      mediaReadyIndicator.classList.remove('active');
      document.getElementById('mediaUpload').value = '';
      
      setStatus('Media point added successfully!', 'saved');
    }
    
    saveToBrowser();
    markUnsaved();
  });

  function addPoint(pData) {
    if (pData.type === 'data' && !points.find(p => p.row === pData.row)) {
      points.push(pData);
    } else if (pData.type === 'media') {
      points.push(pData);
    }
    
    const el = document.createElement('div');
    el.className = 'point';
    
    if (pData.type === 'media') {
      el.classList.add('media-point');
      if (pData.mediaType && pData.mediaType.startsWith('video/')) {
        el.textContent = 'üé•';
      } else {
        el.textContent = 'üì∑';
      }
    } else {
      el.textContent = pData.row;
    }
    
    el.style.left = pData.x + 'px';
    el.style.top = pData.y + 'px';
    el.dataset.id = pData.type === 'data' ? pData.row : points.length;
    el.dataset.type = pData.type || 'data';
    el.dataset.size = pData.size || currentPointSize;
    
    if (pointType === 'data' && pData.type === 'media') {
      el.style.display = 'none';
    } else if (pointType === 'media' && pData.type === 'data') {
      el.style.display = 'none';
    }
    
    const displaySize = (pData.size || currentPointSize) / scale;
    el.style.width = displaySize + 'px';
    el.style.height = displaySize + 'px';
    
    el.addEventListener('contextmenu', e => {
      e.preventDefault();
      const confirmText = pData.type === 'media' 
        ? `Delete media point "${pData.label}"?`
        : `Delete point ${pData.row}?`;
      if(confirm(confirmText)) {
        deletePoint(pData, el);
      }
    });

    el.addEventListener('click', e => {
      if (mode === 'remove') {
        e.stopPropagation();
        const confirmText = pData.type === 'media' 
          ? `Delete media point "${pData.label}"?`
          : `Delete point ${pData.row}?`;
        if(confirm(confirmText)) {
          deletePoint(pData, el);
        }
      }
    });

    container.appendChild(el);
    renderSidebar();
    updateInfoDisplay();
  }

  function deletePoint(pointData, element) {
    if (pointData.type === 'data') {
      points = points.filter(p => !(p.type === 'data' && p.row === pointData.row));
    } else {
      const index = points.indexOf(pointData);
      if (index > -1) points.splice(index, 1);
    }
    element.remove();
    renderSidebar();
    updateInfoDisplay();
    saveToBrowser();
    markUnsaved();
  }

  function renderSidebar() {
    const list = document.getElementById('pointList');
    list.innerHTML = '';
    
    if (points.length === 0) {
      list.innerHTML = '<div style="text-align: center; color: #94a3b8; padding: 20px; font-size: 13px;">Click on the map to add points</div>';
      return;
    }
    
    points.forEach(p => {
      const item = document.createElement('div');
      item.className = 'log-item';
      if (p.type === 'media') item.classList.add('media-item');
      
      const text = p.type === 'media' 
        ? `${p.mediaType && p.mediaType.startsWith('video/') ? 'üé•' : 'üì∑'} ${p.label || p.mediaName}`
        : `üìç Point #${p.row}`;
      
      item.innerHTML = `<span>${text}</span><span class="del-btn">√ó</span>`;
      
      item.querySelector('.del-btn').onclick = () => {
        const confirmText = p.type === 'media' ? `Delete media point "${p.label}"?` : `Delete point ${p.row}?`;
        if (confirm(confirmText)) {
          const el = p.type === 'data'
            ? document.querySelector(`.point[data-id="${p.row}"][data-type="data"]`)
            : Array.from(document.querySelectorAll('.point[data-type="media"]'))[points.filter(pt => pt.type === 'media').indexOf(p)];
          if (el) deletePoint(p, el);
        }
      };
      
      list.appendChild(item);
    });
  }

  document.getElementById('btnSaveViewport').onclick = () => {
    savedViewport = { scale: scale, x: x, y: y, pointSize: currentPointSize };
    document.getElementById('savedViewSection').style.display = 'block';
    document.getElementById('savedZoom').textContent = Math.round(scale * 100) + '%';
    document.getElementById('savedSize').textContent = currentPointSize + 'px';
    document.getElementById('btnSaveViewport').classList.add('saved');
    saveToBrowser();
    setStatus('Viewport saved!', 'saved');
  };

  const STORAGE_KEY = 'floor_editor_v2_professional';
  
  function saveToBrowser() {
    const data = {
      points: points,
      viewport: savedViewport,
      pointSize: currentPointSize,
      nextId: parseInt(nextIdInput.value)
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }
  
  function loadFromBrowser() {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
      const data = JSON.parse(saved);
      
      if (data.points) {
        data.points.forEach(p => addPoint(p));
        const maxId = data.points.filter(p => p.type === 'data').reduce((max, p) => p.row > max ? p.row : max, 0);
        nextIdInput.value = data.nextId || (maxId + 1);
      }
      
      if (data.viewport) {
        savedViewport = data.viewport;
        document.getElementById('savedViewSection').style.display = 'block';
        document.getElementById('savedZoom').textContent = Math.round(data.viewport.scale * 100) + '%';
        document.getElementById('savedSize').textContent = (data.viewport.pointSize || 24) + 'px';
      }
      
      if (data.pointSize) {
        currentPointSize = data.pointSize;
        pointSizeSlider.value = currentPointSize;
        pointSizeInput.value = currentPointSize;
        updateSizePreview();
      }
      
      setStatus('Loaded from browser storage', 'saved');
    }
  }

  function setStatus(text, type) {
    document.getElementById('statusText').textContent = text;
    document.getElementById('statusDot').className = 'status-dot ' + type;
  }
  
  function markUnsaved() {
    hasUnsavedChanges = true;
    setStatus('Unsaved changes', 'unsaved');
  }

  document.getElementById('btnSave').onclick = async () => {
    let plateInfo = [];
    try {
      const res = await fetch('plate_data.json');
      plateInfo = await res.json();
    } catch (e) {
      console.log("No plate_data.json found");
    }

    const finalData = {
      viewportConfig: savedViewport || {
        scale: scale,
        x: x,
        y: y,
        pointSize: currentPointSize
      },
      
      points: points.map(pt => {
        if (pt.type === 'media') {
          return {
            type: 'media',
            x: pt.x,
            y: pt.y,
            size: pt.size || currentPointSize,
            mediaData: pt.mediaData,
            mediaName: pt.mediaName,
            mediaType: pt.mediaType,
            label: pt.label,
            caption: pt.caption
          };
        } else {
          const info = plateInfo[pt.row - 1] || {};
          return {
            type: 'data',
            row: pt.row,
            x: pt.x,
            y: pt.y,
            size: pt.size || currentPointSize,
            plate: info.plate || `Plate ${pt.row}`,
            signals: info.signals || { "Signal": -Math.floor(Math.random()*40+50) }
          };
        }
      })
    };

    const blob = new Blob([JSON.stringify(finalData, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'floor_full_data.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    hasUnsavedChanges = false;
    setStatus('Exported successfully!', 'saved');
    
    const dataCount = points.filter(p => p.type === 'data').length;
    const mediaCount = points.filter(p => p.type === 'media').length;
    
    alert(`‚úÖ File Downloaded!\n\nThe JSON includes:\n‚Ä¢ ${dataCount} data points\n‚Ä¢ ${mediaCount} media points\n‚Ä¢ Initial viewport settings\n‚Ä¢ Point sizes\n\nPlace 'floor_full_data.json' in your project folder.`);
  };

  document.getElementById('btnPlus').onclick = () => zoom(1.2);
  document.getElementById('btnMinus').onclick = () => zoom(0.8);
  document.getElementById('btnFit').onclick = fitToScreen;

  window.onload = () => {
    fitToScreen();
    loadFromBrowser();
  };

  window.onbeforeunload = () => {
    if (hasUnsavedChanges) return "You have unsaved changes. Are you sure you want to leave?";
  };
</script>
</body>
</html>
